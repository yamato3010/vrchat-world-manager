# エラーハンドリング設計書

## 1. 目的
本ドキュメントは、VRChat World Managerにおけるエラーハンドリングの方針と詳細設計を定義する。
ユーザーに適切なフィードバックを提供し、また開発者が問題解決を迅速に行えるように、エラーを分類し、それぞれに対する振る舞いを規定する。

## 2. エラー分類定義

発生しうる事象を以下の3つに分類する。

| 分類 | 定義 | 具体例 | 基本的な対応方針 |
| :--- | :--- | :--- | :--- |
| **正常なエラー** (Normal/Expected Errors) | ユーザー操作やビジネスロジック上で**想定される**否認・失敗。システムとしては正常動作。 | ・フォームの入力不備<br>・検索結果0件<br>・操作キャンセル<br>・重複登録 (Validation) | ・トースト通知やインラインメッセージで理由を提示<br>・再操作を促す |
| **異常なエラー** (Abnormal/System Errors) | システム外部要因や環境要因で発生する障害。ユーザー側で一時的な解決や回避が可能な場合がある。 | ・VRChat APIへの接続失敗 (Network Error)<br>・ファイル読み書き権限エラー<br>・DB接続エラー | ・エラーモーダル/ダイアログを表示<br>・リトライオプションの提示<br>・ログ出力 |
| **想定外のエラー** (Unexpected/Fatal Errors) | 本来起こるべきではないプログラムのバグや論理矛盾。継続不可能な状態。 | ・Null参照エラー (Bug)<br>・未定義のIPCチャンネル呼び出し<br>・メモリ不足 | ・グローバルエラーバウンダリで捕捉<br>・アプリの再起動を促す<br>・詳細ログの出力 |

## 3. レイヤー別方針

### 3.1. Main Process (Backend)
- **IPC Handlers**: 原則として `try...catch` で例外を捕捉する。
- **返却形式**:
    - **正常なエラー**: `Partial<{ success: boolean; error?: string }>` のような結果オブジェクトを返すか、特定の型付きエラーをスローする。
    - **異常/想定外のエラー**: エラーをスローし、レンダラープロセスに `Error invoking remote method` として通知させる。ただし、可能な限り意味のあるエラーメッセージを含める。
- **ログ**: `console.error` で詳細なスタックトレースを出力する。

### 3.2. Renderer Process (Frontend)
- **API呼び出し**: `try...catch` でラップし、エラー種別に応じてUIを切り替える。
- **UIフィードバック**:
    - 軽微なエラー: Toast通知 (e.g. "保存に失敗しました")
    - 重大なエラー: Modal Dialog (e.g. "システムエラーが発生しました")
- **Global Error Boundary**: Reactのレンダリングエラーをキャッチし、クラッシュ画面 ("Oops, something went wrong") を表示する。

## 4. エラーパターン一覧と対応規定

### A. 設定・ファイルシステム (Config & File System)

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| `loadConfig` | 正常 | 設定ファイルなし | 初回起動時など | デフォルト設定を使用 (ユーザー通知なし) |
| | 異常 | 読み込み権限なし | `EACCES` | エラーダイアログ表示 ("設定を読み込めません") |
| `saveConfig` | 異常 | 書き込み失敗 | ディスクフル、権限 | エラーダイアログ表示 ("設定を保存できません") |
| `select-directory`| 正常 | キャンセル | ユーザーが選択せず閉じる | 何もしない (ダイアログを閉じる) |
| `import-photo` | 正常 | メタデータなし | World IDが含まれない | エラーコード `NO_METADATA` で失敗を通知 |

### B. VRChat API 連携

| 機能 | エラー分類 | エラー内容 | 詳細/条件 | 対応規定 (UI挙動) |
| :--- | :--- | :--- | :--- | :--- |
| `fetch-vrchat-world` <br> `accept-suggestion` | 正常 | 該当なし (404) | 削除されたワールドID等 | "ワールドが見つかりません" を表示 |
| | 異常 | ネットワークエラー | オフライン、タイムアウト | "通信エラーが発生しました。接続を確認してください" |
| | 異常 | API制限 (429) | リクエスト過多 | "しばらく時間をおいて試してください" |
| | 異常 | API仕様変更 | レスポンス形式の不一致 | "ワールド情報の取得に失敗しました (API Error)" |

### C. データベース操作 (Prisma)

**実装方針**: Prismaが自動的にエラーをスローするため、明示的なエラー分類は行わない。
エラーは上位のIPC Handlerで捕捉され、レンダラープロセスに伝播される。

主なPrismaエラー例:
- 一意制約違反 (`P2002`): 既に登録済みのワールドIDで作成しようとした場合
- レコード未検出 (`P2025`): 存在しないIDで削除・更新しようとした場合
- DB接続エラー: SQLiteファイル破損や権限エラー

## 5. 実装状況

- [x] **ConfigManager**: ファイル権限エラーのハンドリング
    - `loadConfig`: `ENOENT`は正常系（デフォルト値返却）、`EACCES`は異常系（エラースロー）
- [x] **Photo Import**: `import-photo` でのメタデータなし/APIエラーの分岐処理
    - `errorCode`フィールドを追加: 'NO_METADATA', 'API_ERROR', 'UNKNOWN_ERROR'
- [x] **API Client**: VRChat API呼び出しの統一的なエラー変換 (Network vs 404 vs Server Error)
    - `fetchWorldFromVRChatAPI`ヘルパー関数を実装
    - `fetch-vrchat-world`, `import-photo`, `accept-suggestion`で使用
    - エラーコード: 'NOT_FOUND', 'RATE_LIMIT', 'SERVER_ERROR', 'NETWORK_ERROR', 'UNKNOWN_ERROR'
- [ ] **Frontend**: API呼び出し共通フックでのエラーハンドリング共通化 (Toast表示など)
- [ ] **Frontend**: Global Error Boundary の設置

