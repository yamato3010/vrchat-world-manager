# テスト設計書

## 1. 概要
本ドキュメントは、VRChat World Managerの品質を担保するためのテスト方針と設計をまとめたものである。

## 2. テストレベルと範囲

| レベル | 対象 | 目的 | ツール |
| :--- | :--- | :--- | :--- |
| **ユニットテスト (Frontend)** | Reactコンポーネント, Hooks | 個々のUIパーツの描画、状態遷移、イベントハンドラの動作確認 | Vitest, React Testing Library |
| **ユニットテスト (Backend)** | Utility関数, ConfigManager | 外部依存（DB/API）を含まないロジックの検証 | Vitest |
| **結合テスト (Backend)** | IPC Handlers, Database | データベース操作や外部API連携を含むビジネスロジックの検証 | Vitest, Prisma (In-memory/Test DB) |


---

## 3. バックエンドテスト設計
`electron/` ディレクトリ以下のコードを対象とする。

### 3.1. テスト方法
*   **IPC Handlerを直接呼び出す**: ElectronのIPC通信自体をモックするのではなく、ハンドラー関数そのものをテスト対象とするか、あるいはIPC経由で呼び出されるロジックを分離してテストする。
*   **データベースのモック化**:
    *   **Unit Test**: `prisma-mock` 等を使用してDBアクセスを完全にモックする。
    *   **Integration Test**: テスト用のSQLiteデータベース（メモリ内または一時ファイル）を使用し、実際にクエリを発行して挙動を確認する。
*   **外部API**: `axios` をモックし、VRChat APIへのリクエストを遮断する。

### 3.2. テスト対象とケース一覧

#### A. 設定管理
**目標カバレッジ: C1 100%**
単体テストとして全分岐を網羅する。

| 機能 | テストケースID | 説明 | 期待値 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **loadConfig** | `CONF-001` | 設定ファイルが存在しない場合 | デフォルト設定が返されること | `ENOENT` エラーハンドリング |
| | `CONF-002` | 空のJSONファイルの場合 | デフォルト設定が返されること | JSONパースエラー等のハンドリング |
| | `CONF-003` | 正常な設定ファイルの場合 | ファイルの内容が返されること | |
| | `CONF-004` | 一部のプロパティのみ存在する場合 | デフォルト値とマージされた設定が返されること | `Object.assign` 等の動作確認 |
| | `CONF-005` | 不正なJSON形式の場合 | エラーにならずデフォルト設定が返される、または適切なエラー | 堅牢性の確認 |
| **saveConfig** | `CONF-011` | 正常保存 | 指定したデータがファイルに書き込まれること | |
| | `CONF-012` | 保存先ディレクトリが存在しない場合 | ディレクトリを自動作成して保存成功すること | `mkdir -p` 相当の動作 |
| | `CONF-013` | 書き込み権限がない場合 | エラーがスローされること | 異常系 |

#### B. ワールド管理
**目標カバレッジ: C1 100%**
DB操作を含む結合テスト。

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **get-worlds** | `WORLD-001` | 全件取得（フィルタなし） | 全てのワールドが含まれる配列が返ること |
| | `WORLD-002` | グループID指定フィルタ | 指定グループに紐付くワールドのみが返ること |
| | `WORLD-003` | 存在しないグループID指定 | 空配列が返ること |
| **create-world** | `WORLD-011` | 必須項目のみで作成 | 作成成功し、ID等のフィールドが埋まったデータが返ること |
| | `WORLD-012` | 全項目指定で作成 | 全てのフィールドが正しく保存されること |
| | `WORLD-013` | 不正データ（型不一致等） | エラーになること（Prismaの検証） |
| **update-world** | `WORLD-021` | 正常更新 | 指定フィールドのみ更新されること |
| | `WORLD-022` | 存在しないID指定 | レコードが見つからない旨のエラー（Prisma挙動） |
| **delete-world** | `WORLD-031` | 正常削除 | 削除成功し、該当IDが取得できなくなること |
| | `WORLD-032` | 存在しないID指定 | レコードが見つからない旨のエラー |

#### C. グループ管理

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **create-group** | `GROUP-001` | 正常作成 | IDが発行され保存されること |
| **delete-group** | `GROUP-011` | 単体削除 | グループのみ削除され、所属ワールドは残ること |
| | `GROUP-012` | カスケード削除 (`deleteWorlds: true`) | グループと、そこに所属する**ワールドそのもの**も削除されること |
| **add-world-to-group** | `GROUP-021` | 正常追加 | 中間テーブル (`WorldOnGroup`) にレコードができること |
| | `GROUP-022` | 重複追加 | 一意性制約エラーになるか、無視されること |

---

#### D. 写真管理
**目標カバレッジ: C1 100%**

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **import-photo** | `PHOTO-001` | 正常インポート (既存ワールド) | 写真が保存され、メタデータと紐付いたワールドが返ること |
| | `PHOTO-002` | 新規ワールド作成 | DBにないワールドIDの場合、APIから情報を取得してワールド作成後に写真保存されること |
| | `PHOTO-003` | `targetWorldId` 指定 | メタデータに関わらず指定したワールドIDに紐付くこと |
| | `PHOTO-004` | メタデータなし (IDなし) | エラーが返ること |
| | `PHOTO-005` | APIエラー (新規作成時) | API取得失敗時に適切なエラーが返ること |
| | `PHOTO-006` | 不足データの補完 | APIレスポンスに名前等がない場合、デフォルト値 ('Unknown World') 等が使われること |
| **get-photos-by-world** | `PHOTO-011` | 正常取得 | 指定ワールドの写真一覧が返ること |
| **delete-photo** | `PHOTO-021` | 正常削除 | DBレコードと実際のファイルが削除されること |
| **read-image-base64** | `PHOTO-031` | 正常読み込み | 画像データのBase64文字列が返ること |
| | `PHOTO-032` | 読み込みエラー | ファイルがない等の場合、エラーがスローされること |

#### E. 関連付け

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **add-world-to-group** | `ASSOC-001` | 正常追加 | `WorldOnGroup` レコードが作成されること |
| **remove-world-from-group** | `ASSOC-002` | 正常削除 | `WorldOnGroup` レコードが削除されること |

#### F. 提案機能

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **get-world-suggestions** | `SUGG-001` | 正常取得 | 新規写真のスキャン結果が返ること |
| | `SUGG-002` | 設定なし | 写真ディレクトリ設定がない場合、空配列が返ること |
| | `SUGG-003` | 設定値の反映 | 指定された期間と無視リスト設定がスキャナーに渡されること |
| **accept-suggestion** | `SUGG-011` | 正常承認 | ワールド作成、写真保存、(任意)グループ追加が行われること |
| | `SUGG-012` | APIエラー | 外部APIエラー時に適切に処理されること |
| **dismiss-suggestion** | `SUGG-021` | 正常無視 | 設定の無視リストにIDが追加されること |
| | `SUGG-022` | 重複無視 | 既に無視リストにある場合は重複追加しないこと |
| | `SUGG-023` | 設定保存エラー | エラーが伝播すること |

#### G. エラーハンドリング・エッジケース

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **fetch-vrchat-world** | `API-001` | APIエラー | axiosのエラーが呼び出し元に伝播すること |
| | `API-002` | タグなし | APIレスポンスにタグがない場合でも正常に処理されること |
| | `API-003` | 不正タグ形式 | タグが配列でない場合、空配列として扱われること |
| **select-directory** | `SYS-001` | キャンセル | ダイアログでキャンセルした場合、`null` が返ること |
| | `SYS-002` | ウィンドウなし | ブラウザウィンドウが取得できない場合、`null` が返ること |
| **delete-group** | `GROUP-013` | ワールドなし削除 | 削除対象のワールドが0件の場合でも、グループ削除が成功すること |

#### H. 写真スキャン
`electron/photoScanner.ts` を対象とする。

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **scanForNewPhotos** | `SCAN-001` | 正常スキャン | 指定期間内のPNG画像が検出され、除外リストに含まれないものが返ること |
| | `SCAN-002` | 期間外除外 | 指定期間より古い写真はスキャン対象外になること |
| | `SCAN-003` | 無視リスト除外 | `dismissedWorldIds` に含まれるワールドIDの写真は除外されること |
| | `SCAN-004` | ディレクトリなし | 指定ディレクトリが存在しない場合、エラーにならず空配列が返ること |
| | `SCAN-005` | 再帰スキャン | サブディレクトリ内のPNG画像もスキャンされること |

#### I. メタデータ解析
`electron/utils/pngMetadata.ts` を対象とする。

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **parsePNGMetadata** | `META-001` | 正常解析 | VRChat写真からワールドID等のメタデータが正しく抽出できること |
| | `META-002` | ファイルなし | 存在しないパスを指定した場合、エラーがスローされること |
| | `META-003` | 非PNGファイル | PNGでないファイルを指定した場合、適切にハンドリングされること |
| | `META-004` | IDなし | メタデータはあるがワールドIDが含まれない場合、`worldId: null` が返ること |


#### J. データベース初期化
`electron/ipcHandlers.ts` の初期化ロジックを対象とする。

| 機能 | テストケースID | 説明 | 期待値 |
| :--- | :--- | :--- | :--- |
| **initializeDatabasePath** | `DB-001` | 開発環境 (Not Packaged) | `process.cwd()/dev.db` が返され、コピー処理が走らないこと |
| | `DB-002` | 本番環境 - DBファイルあり | `userData/database.db` が返され、コピー処理が走らないこと |
| | `DB-003` | 本番環境 - DBファイルなし | `userData/database.db` が返され、テンプレートからコピーされること |
| | `DB-004` | 本番環境 - ディレクトリなし | `userData` ディレクトリが作成され、コピーされること |
| | `DB-005` | コピー失敗 | エラーログが出力され、例外はスローされずに処理が継続すること |

## 4. フロントエンドテスト設計
`src/` ディレクトリ以下のコンポーネントを対象とする。

### 4.1. テスト方法
*   **Electron APIのモック**: `window.electronAPI` をグローバルにモック (`vi.stubGlobal`) し、バックエンドからのレスポンスを制御する。
*   **ユーザー操作のシミュレーション**: `userEvent` ライブラリを使用し、クリックや入力操作をテストする。
*   **非同期処理の待機**: `waitFor` や `findBy` を使用し、データロード完了後の表示を確認する。

### 4.2. テスト対象とケース一覧

まだ実装はしていない現在検討・作成中。

#### A. コンポーネント

| コンポーネント | テストケース例 |
| :--- | :--- |
| **WorldList** | ・ワールド一覧が正しくレンダリングされること<br>・検索フィルターが機能すること<br>・「削除」ボタン押下時に確認モーダルが出ること |
| **AddWorldModal** | ・入力フォームのバリデーション（必須入力など）<br>・「追加」ボタン押下時に `createWorld` APIが呼ばれること<br>・モーダルが閉じること |
| **Sidebar** | ・グループ一覧が表示されること<br>・グループ選択時にフィルタリングイベントが発火すること |

#### B. ページ

| ページ | テストケース例 |
| :--- | :--- |
| **WorldDetail** | ・URLパラメータからIDを取得し、詳細情報を表示すること<br>・「編集」モードへの切り替えと保存動作 |

#### C. カスタムHooks
*   **useWorlds**: データ取得中のLoading状態、エラー状態、データ取得完了状態のテスト。

---

## 5. テストデータ・Fixtures
*   **Mock Data**: テストで使用する固定のワールドデータ、設定データ等を `__tests__/fixtures/` に定義する。
*   **Setup File**: `__tests__/setup.ts` にて、Electron APIのモック初期化や、Cleanup処理（テストごとのDOMリセットなど）を記述する。
